<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Virgil E3Kit SDK UMD example</title>
</head>
<body>
    This demo works only in one session (without refresh)!
    <p>
        <label>
            input file:
            <br />
            <input id="file-input" type="file" />
        </label>
    </p>
    <p>
        <label>
            file key (only for decrypt):
            <br />
            <input id="file-key-input" type="text" />
        </label>
    </p>
    <button onclick="encrypt()">encrypt</button>
    <button onclick="decrypt()">decrypt</button>
    <script type="text/javascript" src="https://unpkg.com/@virgilsecurity/e3kit-browser@^2.0.0/dist/browser.asmjs.umd.js"></script>
    <script type="text/javascript">
        const API_URL = 'http://localhost:8080';

        const getToken = async () => {
            const identity = `identity-${Math.random()}`;
            const response = await fetch(`${API_URL}/virgil-jwt?identity=${identity}`);
            const { virgil_jwt: virgilJwt } = await response.json();
            return virgilJwt;
        };

        const sdk = (async () => {
            let message;
            try {
                const eThree = await E3kit.EThree.initialize(getToken);
                await eThree.register();
                await eThree.backupPrivateKey('pa$$w0rd');
                const encryptedMessage = await eThree.encrypt('Success');
                message = await eThree.decrypt(encryptedMessage);

                return eThree;
            } catch (error) {
                message = error.toString();
            } finally {
                showInfo(message);
            }
        })();

        async function encrypt() {
            const eThree = await sdk;

            const abortController = new AbortController();
            // You can get file from <input id="file-input" type="file" /> html tag or
            // create with File API
            const file = document.getElementById('file-input').files[0];

            const { encryptedSharedFile, fileKey } = await eThree.encryptSharedFile(file, {
                signal: abortController.signal,
                chunkSize: 65536, // default chunk is 64kb
                onProgress: ({ bytesProcessed, fileSize }) => {
                    // use this callback to draw a progress bar
                    console.log( bytesProcessed, fileSize)
                }
            });
            download(encryptedSharedFile);
            showInfo('File Key:' + fileKey.toString('base64'))
        }


        async function decrypt() {
            const eThree = await sdk;

            const abortController = new AbortController();
            // You can get file from <input id="file-input" type="file" /> html tag or
            // create with File API
            const encryptedFile = document.getElementById('file-input').files[0];
            const fileKey = document.getElementById('file-key-input').value;

            const decryptedSharedFile = await eThree.decryptSharedFile(file, fileKey, undefined, {
                signal: abortController.signal,
                chunkSize: 65536, // default chunk is 64kb
                onProgress: ({ bytesProcessed, fileSize }) => {
                    // use this callback to draw a progress bar
                    console.log( bytesProcessed, fileSize)
                }
            })

            download(decryptedSharedFile)
        }


        function download(file) {
            var element = document.createElement('a');
            element.setAttribute('href', URL.createObjectURL(file));
            element.setAttribute('download', file.name);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        async function readFileKey(fileKey) {
            const reader = new FileReader();

            reader.readAsArrayBuffer(fileKey);

            const promise = new Promise((resolve, reject) => {
                reader.onload = function() {
                    resolve(new Uint8Array(reader.result));
                };

                reader.onerror = function() {
                    reject(reader.error);
                };
            })

            return await promise;
        }

        function showInfo(message) {
            const paragraph = document.createElement('p');
            const textNode = document.createTextNode(message);
            paragraph.appendChild(textNode);
            document.body.appendChild(paragraph);
        }

    </script>
</body>
</html>
